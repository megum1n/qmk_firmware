#include QMK_KEYBOARD_H

enum layers { MAC, LINUX, WINDOWS, FN, FN_TAB, _EMPTY };

const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS] = {
//    ┌─────────────────┬──────┬──────┬────┬────┬────┬────┬────┬────┬────┬────────┬─────────┬────────┬──────┬──────┬────────┐
//    │       esc       │  f1  │  f2  │ f3 │ f4 │ f5 │ f6 │ f7 │ f8 │ f9 │  f10   │   f11   │  f12   │      │      │        │
//    ├─────────────────┼──────┼──────┼────┼────┼────┼────┼────┼────┼────┼────────┼─────────┼────────┼──────┴──────┼────────┤
//    │        `        │  1   │  2   │ 3  │ 4  │ 5  │ 6  │ 7  │ 8  │ 9  │   0    │    -    │   =    │    bspc     │        │
//    ├─────────────────┼──────┼──────┼────┼────┼────┼────┼────┼────┼────┼────────┼─────────┼────────┼─────────────┼────────┤
//    │ LT(FN_TAB, tab) │  q   │  w   │ e  │ r  │ t  │ y  │ u  │ i  │ o  │   p    │    [    │   ]    │      \      │        │
//    ├─────────────────┼──────┼──────┼────┼────┼────┼────┼────┼────┼────┼────────┼─────────┼────────┴─────────────┼────────┤
//    │  LT(FN, caps)   │  a   │  s   │ d  │ f  │ g  │ h  │ j  │ k  │ l  │   ;    │    '    │         ent          │        │
//    ├─────────────────┴──────┼──────┼────┼────┼────┼────┼────┼────┼────┼────────┼─────────┼───────────────┬──────┼────────┤
//    │          lsft          │  z   │ x  │ c  │ v  │ b  │ n  │ m  │ ,  │   .    │    /    │     rsft      │  up  │ MO(FN) │
//    ├─────────────────┬──────┼──────┼────┴────┴────┴────┴────┴────┴────┼────────┼─────────┼────────┬──────┼──────┼────────┤
//    │      lctl       │ lOPT │ lgui │               spc                │ MO(FN) │ QK_LEAD │ MO(FN) │ left │ down │  rght  │
//    └─────────────────┴──────┴──────┴──────────────────────────────────┴────────┴─────────┴────────┴──────┴──────┴────────┘
[MAC] = LAYOUT_75_ansi(
  KC_ESC             , KC_F1   , KC_F2   , KC_F3 , KC_F4 , KC_F5 , KC_F6 , KC_F7 , KC_F8 , KC_F9   , KC_F10  , KC_F11  , KC_F12  , _______ , _______ , _______,
  KC_GRV             , KC_1    , KC_2    , KC_3  , KC_4  , KC_5  , KC_6  , KC_7  , KC_8  , KC_9    , KC_0    , KC_MINS , KC_EQL  ,      KC_BSPC      , _______,
  LT(FN_TAB, KC_TAB) , KC_Q    , KC_W    , KC_E  , KC_R  , KC_T  , KC_Y  , KC_U  , KC_I  , KC_O    , KC_P    , KC_LBRC , KC_RBRC ,      KC_BSLS      , _______,
  LT(FN, KC_CAPS)    , KC_A    , KC_S    , KC_D  , KC_F  , KC_G  , KC_H  , KC_J  , KC_K  , KC_L    , KC_SCLN , KC_QUOT ,           KC_ENT            , _______,
            KC_LSFT            , KC_Z    , KC_X  , KC_C  , KC_V  , KC_B  , KC_N  , KC_M  , KC_COMM , KC_DOT  , KC_SLSH ,      KC_RSFT      , KC_UP   , MO(FN) ,
  KC_LCTL            , KC_LOPT , KC_LCMD ,                         KC_SPC                          , MO(FN)  , QK_LEAD , MO(FN)  , KC_LEFT , KC_DOWN , KC_RGHT
),

//    ┌─────────────────┬──────┬──────┬────┬────┬────┬────┬────┬────┬────┬────────┬─────────┬────────┬──────┬──────┬────────┐
//    │       esc       │  f1  │  f2  │ f3 │ f4 │ f5 │ f6 │ f7 │ f8 │ f9 │  f10   │   f11   │  f12   │      │      │        │
//    ├─────────────────┼──────┼──────┼────┼────┼────┼────┼────┼────┼────┼────────┼─────────┼────────┼──────┴──────┼────────┤
//    │        `        │  1   │  2   │ 3  │ 4  │ 5  │ 6  │ 7  │ 8  │ 9  │   0    │    -    │   =    │    bspc     │        │
//    ├─────────────────┼──────┼──────┼────┼────┼────┼────┼────┼────┼────┼────────┼─────────┼────────┼─────────────┼────────┤
//    │ LT(FN_TAB, tab) │  q   │  w   │ e  │ r  │ t  │ y  │ u  │ i  │ o  │   p    │    [    │   ]    │      \      │        │
//    ├─────────────────┼──────┼──────┼────┼────┼────┼────┼────┼────┼────┼────────┼─────────┼────────┴─────────────┼────────┤
//    │  LT(FN, caps)   │  a   │  s   │ d  │ f  │ g  │ h  │ j  │ k  │ l  │   ;    │    '    │         ent          │        │
//    ├─────────────────┴──────┼──────┼────┼────┼────┼────┼────┼────┼────┼────────┼─────────┼───────────────┬──────┼────────┤
//    │          lsft          │  z   │ x  │ c  │ v  │ b  │ n  │ m  │ ,  │   .    │    /    │     rsft      │  up  │ MO(FN) │
//    ├─────────────────┬──────┼──────┼────┴────┴────┴────┴────┴────┴────┼────────┼─────────┼────────┬──────┼──────┼────────┤
//    │      lctl       │ lgui │ lalt │               spc                │ MO(FN) │ QK_LEAD │ MO(FN) │ left │ down │  rght  │
//    └─────────────────┴──────┴──────┴──────────────────────────────────┴────────┴─────────┴────────┴──────┴──────┴────────┘
[LINUX] = LAYOUT_75_ansi(
  KC_ESC             , KC_F1   , KC_F2   , KC_F3 , KC_F4 , KC_F5 , KC_F6 , KC_F7 , KC_F8 , KC_F9   , KC_F10  , KC_F11  , KC_F12  , _______ , _______ , _______,
  KC_GRV             , KC_1    , KC_2    , KC_3  , KC_4  , KC_5  , KC_6  , KC_7  , KC_8  , KC_9    , KC_0    , KC_MINS , KC_EQL  ,      KC_BSPC      , _______,
  LT(FN_TAB, KC_TAB) , KC_Q    , KC_W    , KC_E  , KC_R  , KC_T  , KC_Y  , KC_U  , KC_I  , KC_O    , KC_P    , KC_LBRC , KC_RBRC ,      KC_BSLS      , _______,
  LT(FN, KC_CAPS)    , KC_A    , KC_S    , KC_D  , KC_F  , KC_G  , KC_H  , KC_J  , KC_K  , KC_L    , KC_SCLN , KC_QUOT ,           KC_ENT            , _______,
            KC_LSFT            , KC_Z    , KC_X  , KC_C  , KC_V  , KC_B  , KC_N  , KC_M  , KC_COMM , KC_DOT  , KC_SLSH ,      KC_RSFT      , KC_UP   , MO(FN) ,
  KC_LCTL            , KC_LGUI , KC_LALT ,                         KC_SPC                          , MO(FN)  , QK_LEAD , MO(FN)  , KC_LEFT , KC_DOWN , KC_RGHT
),

//    ┌──────┬──────┬──────┬────┬────┬────┬────┬────┬────┬────┬────────┬─────────┬────────┬──────┬──────┬────────┐
//    │ esc  │  f1  │  f2  │ f3 │ f4 │ f5 │ f6 │ f7 │ f8 │ f9 │  f10   │   f11   │  f12   │ pscr │ del  │  pgup  │
//    ├──────┼──────┼──────┼────┼────┼────┼────┼────┼────┼────┼────────┼─────────┼────────┼──────┴──────┼────────┤
//    │  `   │  1   │  2   │ 3  │ 4  │ 5  │ 6  │ 7  │ 8  │ 9  │   0    │    -    │   =    │    bspc     │  pgdn  │
//    ├──────┼──────┼──────┼────┼────┼────┼────┼────┼────┼────┼────────┼─────────┼────────┼─────────────┼────────┤
//    │ tab  │  q   │  w   │ e  │ r  │ t  │ y  │ u  │ i  │ o  │   p    │    [    │   ]    │      \      │  home  │
//    ├──────┼──────┼──────┼────┼────┼────┼────┼────┼────┼────┼────────┼─────────┼────────┴─────────────┼────────┤
//    │ caps │  a   │  s   │ d  │ f  │ g  │ h  │ j  │ k  │ l  │   ;    │    '    │         ent          │  end   │
//    ├──────┴──────┼──────┼────┼────┼────┼────┼────┼────┼────┼────────┼─────────┼───────────────┬──────┼────────┤
//    │    lsft     │  z   │ x  │ c  │ v  │ b  │ n  │ m  │ ,  │   .    │    /    │     rsft      │  up  │ MO(FN) │
//    ├──────┬──────┼──────┼────┴────┴────┴────┴────┴────┴────┼────────┼─────────┼────────┬──────┼──────┼────────┤
//    │ lctl │ lgui │ lalt │               spc                │ MO(FN) │ QK_LEAD │ MO(FN) │ left │ down │  rght  │
//    └──────┴──────┴──────┴──────────────────────────────────┴────────┴─────────┴────────┴──────┴──────┴────────┘
[WINDOWS] = LAYOUT_75_ansi(
  KC_ESC  , KC_F1   , KC_F2   , KC_F3 , KC_F4 , KC_F5 , KC_F6 , KC_F7 , KC_F8 , KC_F9   , KC_F10  , KC_F11  , KC_F12  , KC_PSCR , KC_DEL  , KC_PGUP,
  KC_GRV  , KC_1    , KC_2    , KC_3  , KC_4  , KC_5  , KC_6  , KC_7  , KC_8  , KC_9    , KC_0    , KC_MINS , KC_EQL  ,      KC_BSPC      , KC_PGDN,
  KC_TAB  , KC_Q    , KC_W    , KC_E  , KC_R  , KC_T  , KC_Y  , KC_U  , KC_I  , KC_O    , KC_P    , KC_LBRC , KC_RBRC ,      KC_BSLS      , KC_HOME,
  KC_CAPS , KC_A    , KC_S    , KC_D  , KC_F  , KC_G  , KC_H  , KC_J  , KC_K  , KC_L    , KC_SCLN , KC_QUOT ,           KC_ENT            , KC_END ,
       KC_LSFT      , KC_Z    , KC_X  , KC_C  , KC_V  , KC_B  , KC_N  , KC_M  , KC_COMM , KC_DOT  , KC_SLSH ,      KC_RSFT      , KC_UP   , MO(FN) ,
  KC_LCTL , KC_LGUI , KC_LALT ,                         KC_SPC                          , MO(FN)  , QK_LEAD , MO(FN)  , KC_LEFT , KC_DOWN , KC_RGHT
),

//    ┌─────┬─────────┬───────────┬─────────────┬─────┬─────┬──────┬─────────┬──────┬──────┬─────┬──────┬──────┬─────────┬──────┬──────┐
//    │     │ DF(MAC) │ DF(LINUX) │ DF(WINDOWS) │     │     │      │ QK_BOOT │      │      │     │ bRID │ bRIU │ UG_TOGG │      │      │
//    ├─────┼─────────┼───────────┼─────────────┼─────┼─────┼──────┼─────────┼──────┼──────┼─────┼──────┼──────┼─────────┴──────┼──────┤
//    │     │   f1    │    f2     │     f3      │ f4  │ f5  │  f6  │   f7    │  f8  │  f9  │ f10 │ f11  │ f12  │      del       │      │
//    ├─────┼─────────┼───────────┼─────────────┼─────┼─────┼──────┼─────────┼──────┼──────┼─────┼──────┼──────┼────────────────┼──────┤
//    │     │ MS_BTN1 │   MS_UP   │   MS_BTN2   │     │     │ home │  pgdn   │ pgup │ end  │     │ vold │ volu │                │ f17  │
//    ├─────┼─────────┼───────────┼─────────────┼─────┼─────┼──────┼─────────┼──────┼──────┼─────┼──────┼──────┴────────────────┼──────┤
//    │     │ MS_LEFT │  MS_DOWN  │   MS_RGHT   │     │     │ left │  down   │  up  │ rght │     │      │                       │      │
//    ├─────┴─────────┼───────────┼─────────────┼─────┼─────┼──────┼─────────┼──────┼──────┼─────┼──────┼────────────────┬──────┼──────┤
//    │               │           │             │     │     │ mprv │  mnxt   │      │      │     │      │                │      │      │
//    ├─────┬─────────┼───────────┼─────────────┴─────┴─────┴──────┴─────────┴──────┴──────┼─────┼──────┼──────┬─────────┼──────┼──────┤
//    │     │         │  QK_LEAD  │                        QK_LEAD                         │     │      │      │  mprv   │ mply │ mnxt │
//    └─────┴─────────┴───────────┴────────────────────────────────────────────────────────┴─────┴──────┴──────┴─────────┴──────┴──────┘
[FN] = LAYOUT_75_ansi(
  _______ , DF(MAC) , DF(LINUX) , DF(WINDOWS) , _______ , _______ , _______ , QK_BOOT , _______ , _______ , _______ , KC_BRID , KC_BRIU , UG_TOGG , _______ , _______,
  _______ , KC_F1   , KC_F2     , KC_F3       , KC_F4   , KC_F5   , KC_F6   , KC_F7   , KC_F8   , KC_F9   , KC_F10  , KC_F11  , KC_F12  ,      KC_DEL       , _______,
  _______ , MS_BTN1 , MS_UP     , MS_BTN2     , _______ , _______ , KC_HOME , KC_PGDN , KC_PGUP , KC_END  , _______ , KC_VOLD , KC_VOLU ,      _______      , KC_F17 ,
  _______ , MS_LEFT , MS_DOWN   , MS_RGHT     , _______ , _______ , KC_LEFT , KC_DOWN , KC_UP   , KC_RGHT , _______ , _______ ,           _______           , _______,
       _______      , _______   , _______     , _______ , _______ , KC_MPRV , KC_MNXT , _______ , _______ , _______ , _______ ,      _______      , _______ , _______,
  _______ , _______ , QK_LEAD   ,                                 QK_LEAD                                 , _______ , _______ , _______ , KC_MPRV , KC_MPLY , KC_MNXT
),

//    ┌─────┬─────┬─────────┬─────┬─────┬─────┬──────┬──────┬──────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┐
//    │     │     │         │     │     │     │      │      │      │     │     │     │     │     │     │     │
//    ├─────┼─────┼─────────┼─────┼─────┼─────┼──────┼──────┼──────┼─────┼─────┼─────┼─────┼─────┴─────┼─────┤
//    │     │     │         │     │     │     │      │      │      │     │     │     │     │           │     │
//    ├─────┼─────┼─────────┼─────┼─────┼─────┼──────┼──────┼──────┼─────┼─────┼─────┼─────┼───────────┼─────┤
//    │     │     │         │     │     │     │      │      │      │     │     │     │     │           │     │
//    ├─────┼─────┼─────────┼─────┼─────┼─────┼──────┼──────┼──────┼─────┼─────┼─────┼─────┴───────────┼─────┤
//    │     │     │         │     │     │     │ home │ pgdn │ pgup │ end │     │     │                 │     │
//    ├─────┴─────┼─────────┼─────┼─────┼─────┼──────┼──────┼──────┼─────┼─────┼─────┼───────────┬─────┼─────┤
//    │           │         │     │     │     │ mprv │ mnxt │      │     │     │     │           │     │     │
//    ├─────┬─────┼─────────┼─────┴─────┴─────┴──────┴──────┴──────┴─────┼─────┼─────┼─────┬─────┼─────┼─────┤
//    │     │     │ QK_LEAD │                    mply                    │     │     │     │     │     │     │
//    └─────┴─────┴─────────┴────────────────────────────────────────────┴─────┴─────┴─────┴─────┴─────┴─────┘
[FN_TAB] = LAYOUT_75_ansi(
  _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______,
  _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ ,      _______      , _______,
  _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ ,      _______      , _______,
  _______ , _______ , _______ , _______ , _______ , _______ , KC_HOME , KC_PGDN , KC_PGUP , KC_END  , _______ , _______ ,           _______           , _______,
       _______      , _______ , _______ , _______ , _______ , KC_MPRV , KC_MNXT , _______ , _______ , _______ , _______ ,      _______      , _______ , _______,
  _______ , _______ , QK_LEAD ,                               KC_MPLY                               , _______ , _______ , _______ , _______ , _______ , _______
),

//    ┌─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┐
//    │     │     │     │     │     │     │     │     │     │     │     │     │     │     │     │     │
//    ├─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┴─────┼─────┤
//    │     │     │     │     │     │     │     │     │     │     │     │     │     │           │     │
//    ├─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼───────────┼─────┤
//    │     │     │     │     │     │     │     │     │     │     │     │     │     │           │     │
//    ├─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┴───────────┼─────┤
//    │     │     │     │     │     │     │     │     │     │     │     │     │                 │     │
//    ├─────┴─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼───────────┬─────┼─────┤
//    │           │     │     │     │     │     │     │     │     │     │     │           │     │     │
//    ├─────┬─────┼─────┼─────┴─────┴─────┴─────┴─────┴─────┴─────┼─────┼─────┼─────┬─────┼─────┼─────┤
//    │     │     │     │                                         │     │     │     │     │     │     │
//    └─────┴─────┴─────┴─────────────────────────────────────────┴─────┴─────┴─────┴─────┴─────┴─────┘
[_EMPTY] = LAYOUT_75_ansi(
  _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______,
  _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ ,      _______      , _______,
  _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ ,      _______      , _______,
  _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ ,           _______           , _______,
       _______      , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ , _______ ,      _______      , _______ , _______,
  _______ , _______ , _______ ,                               _______                               , _______ , _______ , _______ , _______ , _______ , _______
)
};

bool mac_detected = false;
int default_layer = LINUX;

// Change default layer according to detected OS
bool process_detected_host_os_kb(os_variant_t detected_os) {
    if (!process_detected_host_os_user(detected_os)) {
        return false;
    }

    switch (detected_os) {
        case OS_MACOS:
        case OS_IOS:
            mac_detected = true;
            default_layer = MAC;
            break;
        case OS_WINDOWS:
            default_layer = WINDOWS;
            break;
        case OS_LINUX:
        case OS_UNSURE:
            break;
    }

    set_single_default_layer(default_layer);

    return true;
}

// Backlight for layers
const rgblight_segment_t PROGMEM mac_layer[] = RGBLIGHT_LAYER_SEGMENTS(
    {0, RGBLIGHT_LED_COUNT, HSV_PINK}
);
const rgblight_segment_t PROGMEM linux_layer[] = RGBLIGHT_LAYER_SEGMENTS(
    {0, RGBLIGHT_LED_COUNT, HSV_SPRINGGREEN}
);
const rgblight_segment_t PROGMEM windows_layer[] = RGBLIGHT_LAYER_SEGMENTS(
    {0, RGBLIGHT_LED_COUNT, HSV_ORANGE}
);

const rgblight_segment_t PROGMEM fn_layer[] = RGBLIGHT_LAYER_SEGMENTS(
    {0, 3, HSV_PURPLE},
    {13, 5, HSV_PURPLE}
);
const rgblight_segment_t PROGMEM fn_tab_layer[] = RGBLIGHT_LAYER_SEGMENTS(
    {2, 3, HSV_MAGENTA}
);

const rgblight_segment_t* const PROGMEM rgb_layers[] = RGBLIGHT_LAYERS_LIST(
    mac_layer,
    linux_layer,
    windows_layer,
    fn_layer,
    fn_tab_layer
);

void keyboard_post_init_user(void) {
    rgblight_layers = rgb_layers;
}

layer_state_t default_layer_state_set_user(layer_state_t state) {
    rgblight_set_layer_state(0, layer_state_cmp(state, MAC));
    rgblight_set_layer_state(1, layer_state_cmp(state, LINUX));
    rgblight_set_layer_state(2, layer_state_cmp(state, WINDOWS));

    return state;
}

layer_state_t layer_state_set_user(layer_state_t state) {
    rgblight_set_layer_state(3, layer_state_cmp(state, FN));
    rgblight_set_layer_state(4, layer_state_cmp(state, FN_TAB));

    return state;
}

// Lead key
void leader_end_user(void) {
    // LEAD + S + S = GUI/ALT + S
    if (leader_sequence_two_keys(KC_S, KC_S)) {
        if (mac_detected) {
            tap_code16(LSA(KC_S));
        } else {
            tap_code16(LSG(KC_S));
        }

        return;
    }
}

